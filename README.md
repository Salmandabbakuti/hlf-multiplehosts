# hlf-multiplehosts

### Structure 
```
Org1
├─Peers
├   ├─peer0.org1.example.com
├   ├─peer1.org1.example.com
├   ├─peer2.org1.example.com
├
├─Orderers
├    ├─orderer0.0rg1.example.com
├    ├─orderer1.org1.example.com
├    ├─orderer2.org1.example.com
├
├─ca.example.com

```
<img align="center" src="https://github.com/Salmandabbakuti/hlf-multiplehosts/blob/master/structure.png">

### Steps

##### 1. Clone Repository and Modify Docker files ```extra-hosts``` with your Server IPs

```
git clone https://github.com/Salmandabbakuti/hlf-multiplehosts.git

cd hlf-multiple-hosts

```
##### 2. Generate Crypto matirials, Genesis blocks and Channel tx files

```
export PATH=$PWD/bin:$PATH

export FABRIC_CFG_PATH=${PWD}/fabric-config

cryptogen generate --config=./fabric-config/crypto-config.yaml

configtxgen -profile OneOrgsOrdererGenesis -outputBlock ./network-config/orderer.block

configtxgen -profile OneOrgsChannel -outputCreateChannelTx ./network-config/channel.tx -channelID mychannel

configtxgen -profile OneOrgsChannel -outputAnchorPeersUpdate ./network-config/Org1MSPanchors.tx -channelID mychannel -asOrg Org1MSP
```

##### 3.Exporting Entire Project Directory to all hosts Using git

```
git init
git add .
git commit -m "adding crypto-files"
git remote add origin <Your Remote Repository URL>

git push -u origin master

git clone <Your Repository URL>     #clone to all 3 hosts

cd hlf-multiplehosts
```
##### 4. Start Containers(peers and cli) on all hosts using deployment directory

**Modify ca container in ```docker-compose-kafka.yml``` file with exact keyfile generated**

```
docker-compose  -f deployment/docker-compose-kafka.yml up -d //Main Services orderers and ca, kafka on server1

docker-compose -f deployment/docker-compose-peer0.yml up -d   #peer0 container on server2

docker-compose -f deployment/docker-compose-cli0.yml up -d    #peer0 cli container on server2

#Do the same for remaining peers

```

##### 5. Setup Channel

create channel from peer0 and Join

```
docker exec -e "CORE_PEER_LOCALMSPID=Org1MSP" -e "CORE_PEER_MSPCONFIGPATH=/var/hyperledger/users/Admin@org1.example.com/msp" peer0.org1.example.com peer channel create -o orderer0.example.com:7050 -c mychannel -f /var/hyperledger/configs/channel.tx

#join Peer0 to channel 

docker exec -e "CORE_PEER_LOCALMSPID=Org1MSP" -e "CORE_PEER_MSPCONFIGPATH=/var/hyperledger/users/Admin@org1.example.com/msp" peer0.org1.example.com peer channel join -b mychannel.block

```
##### 6. Joining Peers to channel 

In order to join peers, we must have mychannel.block generated by channel creator(peer0). so Copy mychannel.block from peer0 docker container to all hosts docker containers
```
docker cp peer0.org1.example.com:/mychannel.block .  #it will be copied to your current directory download this file to your local computer and upload to remote peer hosts

docker cp mychannel.block peer1.org1.example.com:/mychannel.block # copies mychannel.block to  peer1 container

docker exec -e "CORE_PEER_LOCALMSPID=Org1MSP" -e "CORE_PEER_MSPCONFIGPATH=/var/hyperledger/users/Admin@org1.example.com/msp" peer1.org1.example.com peer channel join -b mychannel.block #joins peer1 to exisisting channel (execute from server3)

docker cp mychannel.block peer2.org1.example.com:/mychannel.block

docker exec -e "CORE_PEER_LOCALMSPID=Org1MSP" -e "CORE_PEER_MSPCONFIGPATH=/var/hyperledger/users/Admin@org1.example.com/msp" peer2.org1.example.com peer channel join -b mychannel.block #(execute from server4)

```

##### 7. Setup Chaincode

```
docker exec -it cli peer chaincode install -n mycc -p github.com/chaincode -v v0  #execute from all 3 peers

docker exec -it cli peer chaincode instantiate -o orderer0.example.com:7050 -C mychannel -n mycc github.com/chaincode -v v0 -c '{"Args": ["a", "100"]}' #instantiation one time for channel not for every peer
```

##### 8. Invoke and Querying Chaincode

```
docker exec -it cli peer chaincode invoke -o orderer0.example.com:7050 -n mycc -c '{"Args":["set", "a", "20"]}' -C mychannel

docker exec -it cli peer chaincode query -n mycc -c '{"Args":["query","a"]}' -C mychannel  #querying can be done on any peer via cli

```

